{% extends 'VET/base_vet.html' %}
{% block title %}Clinical Coordination | {{ selected_center.name|default:"Chat" }}{% endblock %}

{% block body %}
<div class="container animate-fade" style="margin-top: 60px;">
    <!-- Header -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 50px; flex-wrap: wrap; gap: 20px;">
        <div>
            <div
                style="display: flex; align-items: center; gap: 10px; color: var(--accent); font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px;">
                <i class="fas fa-shield-alt"></i> Secure Medical Link
            </div>
            <h2 style="font-size: clamp(28px, 4vw, 36px); font-weight: 900; margin-bottom: 8px; letter-spacing: -1px;">
                Facility Coordination</h2>
            <p style="color: var(--text-secondary); font-size: 16px;">Direct synchronization with care center staff for
                therapeutic oversight.</p>
        </div>
        <a href="/vet_home/" class="btn btn-outline" style="padding: 14px 28px; border-radius: 16px; font-weight: 700;">
            <i class="fas fa-th-large"></i> Dashboard
        </a>
    </div>

    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 40px; height: 750px; align-items: stretch;">
        <!-- Sidebar: Care Centers -->
        <div class="card"
            style="padding: 0; overflow: hidden; display: flex; flex-direction: column; border-radius: 32px; border: 1px solid var(--border); background: rgba(0,0,0,0.2);">
            <div style="padding: 30px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border);">
                <div style="position: relative;">
                    <i class="fas fa-search"
                        style="position: absolute; left: 15px; top: 12px; color: var(--text-secondary); font-size: 14px;"></i>
                    <input type="text" placeholder="Filter facilities..."
                        style="width: 100%; padding: 10px 15px 10px 40px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; color: #fff; font-size: 13px; outline: none;">
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 20px;" class="custom-scrollbar">
                {% for c in centers %}
                <a href="/vet_chat_care/?id={{ c.id }}"
                    style="text-decoration: none; display: block; margin-bottom: 12px;">
                    <div class="contact-item {% if selected_center and selected_center.id == c.id %}active{% endif %}"
                        style="padding: 15px; border-radius: 20px; transition: 0.3s; display: flex; align-items: center; gap: 15px; border: 1px solid transparent;">
                        <div style="position: relative;">
                            {% if c.image %}
                            <img src="{{ c.image.url }}"
                                style="width: 50px; height: 50px; border-radius: 15px; object-fit: cover; border: 2px solid {% if selected_center and selected_center.id == c.id %}var(--accent){% else %}transparent{% endif %};">
                            {% else %}
                            <div
                                style="width: 50px; height: 50px; border-radius: 15px; background: rgba(0, 242, 254, 0.1); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                <i class="fas fa-hospital"></i>
                            </div>
                            {% endif %}
                            <div
                                style="position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px; border-radius: 50%; background: var(--accent-green); border: 2px solid #121212;">
                            </div>
                        </div>
                        <div style="flex: 1; overflow: hidden;">
                            <p
                                style="margin: 0; font-weight: 700; color: #fff; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ c.name }}</p>
                            <p
                                style="margin: 3px 0 0; font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                Official Care Facility</p>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="card"
            style="padding: 0; overflow: hidden; display: flex; flex-direction: column; border-radius: 32px; border: 1px solid var(--border); background: rgba(0,0,0,0.15);">
            {% if selected_center %}
            <!-- Chat Info Header -->
            <div
                style="padding: 25px 40px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="position: relative;">
                        {% if selected_center.image %}
                        <img src="{{ selected_center.image.url }}"
                            style="width: 45px; height: 45px; border-radius: 12px; object-fit: cover;">
                        {% else %}
                        <div
                            style="width: 45px; height: 45px; border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-hospital"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        <h4 style="margin: 0; font-size: 18px; font-weight: 800; color: #fff;">
                            <span>{{ selected_center.name|default:"Care Center" }}</span>
                        </h4>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 2px;">
                            <span
                                style="width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green);"></span>
                            <small style="color: var(--text-secondary); font-size: 12px; font-weight: 600;">ACTIVE
                                CONSULTATION</small>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline"
                        style="width: 45px; height: 45px; border-radius: 12px; padding: 0;"><i
                            class="fas fa-phone"></i></button>
                    <button class="btn btn-outline"
                        style="width: 45px; height: 45px; border-radius: 12px; padding: 0;"><i
                            class="fas fa-info-circle"></i></button>
                </div>
            </div>

            <!-- Messages Window -->
            <div id="messages-window"
                style="flex: 1; padding: 40px; overflow-y: auto; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');"
                class="custom-scrollbar">
                <div style="display: flex; flex-direction: column; gap: 25px;">
                    {% for chat in chats %}
                    <div
                        style="display: flex; {% if chat.sender_type == 'vet' %}justify-content: flex-end{% endif %}; align-items: flex-end; gap: 12px;">
                        {% if chat.sender_type != 'vet' %}
                        {% if selected_center.image %}
                        <img src="{{ selected_center.image.url }}"
                            style="width: 30px; height: 30px; border-radius: 8px; object-fit: cover;">
                        {% else %}
                        <div
                            style="width: 30px; height: 30px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 12px;">
                            <i class="fas fa-hospital"></i>
                        </div>
                        {% endif %}
                        {% endif %}

                        <div style="max-width: 65%; position: relative;">
                            <div style="padding: 16px 22px; border-radius: 22px; font-size: 15px; line-height: 1.6; font-weight: 500;
                                       {% if chat.sender_type == 'vet' %}
                                       background: linear-gradient(135deg, var(--accent), #00d2ff); color: #000; border-bottom-right-radius: 4px; box-shadow: 0 10px 20px rgba(0, 242, 254, 0.1);
                                       {% else %}
                                       background: rgba(255,255,255,0.08); color: #fff; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px);
                                       {% endif %}">
                                {{ chat.message }}
                            </div>
                            <div
                                style="display: flex; align-items: center; gap: 6px; margin-top: 6px; {% if chat.sender_type == 'vet' %}justify-content: flex-end{% endif %}">
                                <small
                                    style="font-size: 10px; color: var(--text-secondary); font-weight: 700; opacity: 0.6;">
                                    {{ chat.sent_at|date:"M d, H:i" }}
                                </small>
                                {% if chat.sender_type == 'vet' %}
                                <i class="fas fa-check-double" style="font-size: 10px; color: var(--accent);"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div style="text-align: center; margin-top: 150px; opacity: 0.25;">
                        <div
                            style="width: 80px; height: 80px; border-radius: 50%; border: 2px dashed var(--text-secondary); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-comment-slash fa-2x"></i>
                        </div>
                        <h4 style="font-size: 18px; font-weight: 700;">No History Available</h4>
                        <p style="font-size: 14px;">Establish a medical directive by sending a message below.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Message Input -->
            <div style="padding: 30px 45px; background: rgba(255,255,255,0.03); border-top: 1px solid var(--border);">
                <form method="POST"
                    style="display: flex; gap: 15px; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 24px; border: 1px solid var(--border);">
                    {% csrf_token %}
                    <input type="hidden" name="care_id" value="{{ selected_center.id }}">
                    <div style="display: flex; align-items: center; padding-left: 15px; color: var(--text-secondary);">
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <input type="text" name="message" required autocomplete="off"
                        placeholder="Write a clinical directive..."
                        style="flex: 1; padding: 12px 10px; background: transparent; border: none; color: #fff; font-size: 15px; outline: none;">
                    <button type="submit" class="btn btn-primary"
                        style="width: 50px; height: 50px; border-radius: 18px; padding: 0; background: var(--accent); color: #000; border: none;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
            {% else %}
            <!-- Welcome View -->
            <div
                style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px; text-align: center;">
                <div
                    style="width: 120px; height: 120px; background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(0, 242, 254, 0.05)); border-radius: 40px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; border: 1px solid rgba(0, 242, 254, 0.2); transform: rotate(-5deg);">
                    <i class="fas fa-comments fa-4x" style="color: var(--accent); transform: rotate(5deg);"></i>
                </div>
                <h3 style="font-size: 26px; font-weight: 900; margin-bottom: 15px; color: #fff;">Medical Coordination
                </h3>
                <p
                    style="max-width: 440px; color: var(--text-secondary); line-height: 1.8; font-size: 15px; margin-bottom: 40px;">
                    Select an approved care center from the registry to initiate clinical consultations or review
                    historical directives.</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 400px;">
                    <div class="card" style="padding: 20px; background: rgba(255,255,255,0.02); text-align: center;">
                        <i class="fas fa-file-medical-alt" style="color: var(--accent); margin-bottom: 15px;"></i>
                        <p style="margin: 0; font-size: 12px; font-weight: 700; color: #fff;">Direct Protocols</p>
                    </div>
                    <div class="card" style="padding: 20px; background: rgba(255,255,255,0.02); text-align: center;">
                        <i class="fas fa-clock" style="color: var(--accent); margin-bottom: 15px;"></i>
                        <p style="margin: 0; font-size: 12px; font-weight: 700; color: #fff;">Audit History</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    .contact-item:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateX(5px);
    }

    .contact-item.active {
        background: rgba(0, 242, 254, 0.1) !important;
        border-color: rgba(0, 242, 254, 0.2) !important;
    }
</style>

<script>
    window.onload = function () {
        var objDiv = document.getElementById("messages-window");
        if (objDiv) objDiv.scrollTop = objDiv.scrollHeight;
    }
</script>
{% endblock %}